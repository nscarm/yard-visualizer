<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0F172A">
    <title>Material Visualizer</title>
    <style>
        :root {
            --primary: #3B82F6;
            --primary-dark: #2563EB;
            --primary-light: #60A5FA;
            --secondary: #8B5CF6;
            --background: #0F172A;
            --surface: #1E293B;
            --surface-light: #334155;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --success: #10B981;
            --error: #EF4444;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Background gradient effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15), transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 20px 24px;
            padding-top: max(20px, env(safe-area-inset-top));
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        /* Progress Bar */
        .progress-container {
            padding: 0 24px 24px;
        }

        .progress-bar {
            height: 4px;
            background: var(--surface);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .step-indicator {
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Main Content */
        .content {
            flex: 1;
            padding: 0 24px;
            padding-bottom: max(24px, env(safe-area-inset-bottom));
        }

        .step {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .step-description {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.5;
        }

        /* Upload Card */
        .upload-card {
            background: var(--surface);
            border-radius: 20px;
            border: 2px dashed var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-card.has-image {
            border-color: var(--primary);
            border-style: solid;
        }

        .upload-label {
            display: block;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .upload-label:active {
            background: rgba(255, 255, 255, 0.02);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 16px;
        }

        .upload-icon svg {
            width: 32px;
            height: 32px;
            stroke: var(--primary);
        }

        .upload-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .upload-subtext {
            font-size: 13px;
            color: var(--text-secondary);
        }

        input[type="file"] {
            display: none;
        }

        .preview-container {
            position: relative;
            display: none;
        }

        .preview-container.active {
            display: block;
        }

        .preview-image {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 18px;
        }

        .preview-overlay {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .preview-badge {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .change-btn {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .change-btn:active {
            background: rgba(15, 23, 42, 0.95);
        }

        .change-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-primary);
        }

        /* Buttons */
        .button-group {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 24px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            background: linear-gradient(to top, var(--background) 70%, transparent);
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
        }

        .btn-secondary:active {
            background: var(--surface-light);
        }

        .btn svg {
            width: 20px;
            height: 20px;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 24px;
            position: relative;
        }

        .spinner-ring {
            position: absolute;
            inset: 0;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            border-top-color: var(--secondary);
            animation-delay: 0.2s;
            animation-duration: 1.2s;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Results */
        .result-image {
            width: 100%;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 24px var(--shadow);
        }

        .result-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 100px;
        }

        /* Error State */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .error-message p {
            font-size: 14px;
            color: var(--error);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </div>
                <span class="logo-text">Material Visualizer</span>
            </div>
        </div>

        <!-- Progress -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="step-indicator">
                <span id="stepNumber">Step 1</span> of 3
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Step 1: Material Upload -->
            <div class="step active" id="step1">
                <h1 class="step-title">Choose Material</h1>
                <p class="step-description">Upload a photo of the material or texture you want to visualize</p>
                
                <div class="upload-card" id="materialCard">
                    <label for="materialInput" class="upload-label" id="materialLabel">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="M21 15l-5-5L5 21"/>
                            </svg>
                        </div>
                        <div class="upload-text">Tap to upload</div>
                        <div class="upload-subtext">Take photo or choose from library</div>
                    </label>
                    <input type="file" id="materialInput" accept="image/*">
                    <div class="preview-container" id="materialPreview">
                        <img id="materialImage" class="preview-image" alt="Material">
                        <div class="preview-overlay">
                            <div class="preview-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                Uploaded
                            </div>
                            <button class="change-btn" onclick="document.getElementById('materialInput').click()">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="error-message" id="error1">
                    <p>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span id="error1Text"></span>
                    </p>
                </div>
            </div>

            <!-- Step 2: Yard Upload -->
            <div class="step" id="step2">
                <h1 class="step-title">Upload Yard Photo</h1>
                <p class="step-description">Take or upload a photo of the area where you want to apply the material</p>
                
                <div class="upload-card" id="yardCard">
                    <label for="yardInput" class="upload-label" id="yardLabel">
                        <div class="upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                        </div>
                        <div class="upload-text">Tap to capture</div>
                        <div class="upload-subtext">Best results with clear, well-lit photos</div>
                    </label>
                    <input type="file" id="yardInput" accept="image/*">
                    <div class="preview-container" id="yardPreview">
                        <img id="yardImage" class="preview-image" alt="Yard">
                        <div class="preview-overlay">
                            <div class="preview-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                Uploaded
                            </div>
                            <button class="change-btn" onclick="document.getElementById('yardInput').click()">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="error-message" id="error2">
                    <p>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span id="error2Text"></span>
                    </p>
                </div>
            </div>

            <!-- Step 3: Results -->
            <div class="step" id="step3">
                <h1 class="step-title">Your Visualization</h1>
                <p class="step-description">Here's how the material will look in your space</p>
                
                <img id="resultImage" class="result-image" alt="Result">
                
                <div class="result-actions">
                    <button class="btn btn-secondary" onclick="resetApp()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <polyline points="1 4 1 10 7 10"/>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                        </svg>
                        Start Over
                    </button>
                    <button class="btn btn-primary" id="downloadBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download
                    </button>
                </div>
            </div>
        </div>

        <!-- Button Group -->
        <div class="button-group">
            <button class="btn btn-secondary" id="backBtn" onclick="previousStep()" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
                Back
            </button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextStep()" disabled>
                Continue
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <line x1="5" y1="12" x2="19" y2="12"/>
                    <polyline points="12 5 19 12 12 19"/>
                </svg>
            </button>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                </div>
                <div class="loading-text" id="loadingText">Generating visualization...</div>
                <div class="loading-subtext">This may take up to 3 minutes</div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // YARD MATERIAL VISUALIZER - PROFESSIONAL VERSION
        // ============================================================================
        
        let currentStep = 1;
        let materialImage = null;
        let yardImage = null;
        let resultUrl = null;

        // Step Management
        function updateProgress() {
            const progress = ((currentStep - 1) / 2) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('stepNumber').textContent = `Step ${currentStep}`;
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            
            const backBtn = document.getElementById('backBtn');
            const nextBtn = document.getElementById('nextBtn');
            const buttonGroup = document.querySelector('.button-group');
            
            if (step === 1) {
                backBtn.style.display = 'none';
                nextBtn.style.flex = '1';
            } else if (step === 2) {
                backBtn.style.display = 'flex';
                nextBtn.style.flex = '1';
            } else {
                buttonGroup.style.display = 'none';
            }
            
            updateProgress();
        }

        function nextStep() {
            if (currentStep === 1 && !materialImage) return;
            if (currentStep === 2 && !yardImage) return;
            
            if (currentStep === 2) {
                generateVisualization();
                return;
            }
            
            currentStep++;
            showStep(currentStep);
            checkContinueButton();
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                checkContinueButton();
            }
        }

        function checkContinueButton() {
            const nextBtn = document.getElementById('nextBtn');
            
            if (currentStep === 1) {
                nextBtn.disabled = !materialImage;
            } else if (currentStep === 2) {
                nextBtn.disabled = !yardImage;
            }
        }

        // Image Upload Handlers
        document.getElementById('materialInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                materialImage = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('materialImage').src = e.target.result;
                    document.getElementById('materialPreview').classList.add('active');
                    document.getElementById('materialLabel').style.display = 'none';
                    document.getElementById('materialCard').classList.add('has-image');
                };
                reader.readAsDataURL(file);
                checkContinueButton();
            }
        });

        document.getElementById('yardInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                yardImage = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('yardImage').src = e.target.result;
                    document.getElementById('yardPreview').classList.add('active');
                    document.getElementById('yardLabel').style.display = 'none';
                    document.getElementById('yardCard').classList.add('has-image');
                };
                reader.readAsDataURL(file);
                checkContinueButton();
            }
        });

        // Image Processing
        async function fileToDataUri(file, maxWidth = 1920) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (height / width) * maxWidth;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUri = canvas.toDataURL('image/jpeg', 0.85);
                    resolve(dataUri);
                };
                
                img.onerror = reject;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Generate Visualization
        async function generateVisualization() {
            try {
                document.getElementById('loadingOverlay').classList.add('active');
                document.getElementById('loadingText').textContent = 'Processing images...';
                
                const materialDataUri = await fileToDataUri(materialImage);
                const yardDataUri = await fileToDataUri(yardImage);
                
                document.getElementById('loadingText').textContent = 'Generating visualization...';
                
                const response = await fetch('https://caldg-ai-proxy.nickscarmozzino.workers.dev/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: "Apply the material texture from the first image to cover the yard area in the second image. Make it look realistic and natural, as if the material has been professionally installed. Keep the house, landscaping rocks, and other elements unchanged - only replace the dirt/soil areas with the new material texture.",
                        image_urls: [materialDataUri, yardDataUri]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Generation failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success && data.images && data.images.length > 0) {
                    resultUrl = data.images[0].url;
                    document.getElementById('resultImage').src = resultUrl;
                    
                    document.getElementById('loadingOverlay').classList.remove('active');
                    currentStep = 3;
                    showStep(3);
                } else if (data.error) {
                    throw new Error(data.error);
                } else {
                    throw new Error('No images in response');
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingOverlay').classList.remove('active');
                
                const errorEl = document.getElementById('error2');
                document.getElementById('error2Text').textContent = error.message;
                errorEl.classList.add('active');
                
                setTimeout(() => {
                    errorEl.classList.remove('active');
                }, 5000);
            }
        }

        // Download Result
        document.getElementById('downloadBtn').addEventListener('click', async function() {
            if (resultUrl) {
                try {
                    const response = await fetch(resultUrl);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `yard-visualization-${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    window.open(resultUrl, '_blank');
                }
            }
        });

        // Reset App
        function resetApp() {
            currentStep = 1;
            materialImage = null;
            yardImage = null;
            resultUrl = null;
            
            document.getElementById('materialInput').value = '';
            document.getElementById('yardInput').value = '';
            document.getElementById('materialPreview').classList.remove('active');
            document.getElementById('yardPreview').classList.remove('active');
            document.getElementById('materialLabel').style.display = 'block';
            document.getElementById('yardLabel').style.display = 'block';
            document.getElementById('materialCard').classList.remove('has-image');
            document.getElementById('yardCard').classList.remove('has-image');
            document.querySelector('.button-group').style.display = 'flex';
            
            showStep(1);
            checkContinueButton();
        }

        // Initialize
        updateProgress();
        checkContinueButton();
    </script>
</body>
</html>